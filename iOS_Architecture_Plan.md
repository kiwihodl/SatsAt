# Satsat - iOS Multisig Bitcoin Savings App

## Complete Implementation Architecture

### üèóÔ∏è iOS App Structure

```
Satsat/
‚îú‚îÄ‚îÄ App/
‚îÇ   ‚îú‚îÄ‚îÄ SatsatApp.swift                    # Main app entry point
‚îÇ   ‚îî‚îÄ‚îÄ ContentView.swift                  # Root view
‚îú‚îÄ‚îÄ Core/
‚îÇ   ‚îú‚îÄ‚îÄ Security/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ KeychainManager.swift          # Encrypted storage
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CryptoManager.swift            # Encryption utilities
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BiometricAuth.swift           # Touch/Face ID
‚îÇ   ‚îú‚îÄ‚îÄ Bitcoin/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MultisigWallet.swift          # Caravan integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PSBTManager.swift             # Transaction signing
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LightningManager.swift        # Lightning Network
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BitcoinService.swift          # Core Bitcoin logic
‚îÇ   ‚îú‚îÄ‚îÄ Nostr/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NostrClient.swift             # Relay management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EventManager.swift            # Event creation/signing
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageEncryption.swift       # NIP-04/44 encryption
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ InviteManager.swift           # Group invites
‚îÇ   ‚îî‚îÄ‚îÄ Networking/
‚îÇ       ‚îú‚îÄ‚îÄ RelayConnection.swift         # WebSocket management
‚îÇ       ‚îî‚îÄ‚îÄ APIService.swift             # External APIs
‚îú‚îÄ‚îÄ Features/
‚îÇ   ‚îú‚îÄ‚îÄ Onboarding/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ KeySetupView.swift           # Nostr key generation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PermissionsView.swift        # Notification setup
‚îÇ   ‚îú‚îÄ‚îÄ Groups/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateGroupView.swift        # Pool creation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JoinGroupView.swift          # Join via invite
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GroupDashboardView.swift     # Main pool view
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MemberManagementView.swift   # Add/remove members
‚îÇ   ‚îú‚îÄ‚îÄ Wallet/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ReceiveView.swift            # Address generation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SendView.swift               # PSBT creation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TransactionHistoryView.swift # TX history
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PSBTSigningView.swift        # QR signing flow
‚îÇ   ‚îú‚îÄ‚îÄ Messaging/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GroupChatView.swift          # NIP-04 messaging
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MessageBubbleView.swift      # Chat UI components
‚îÇ   ‚îî‚îÄ‚îÄ Settings/
‚îÇ       ‚îú‚îÄ‚îÄ SettingsView.swift           # App preferences
‚îÇ       ‚îú‚îÄ‚îÄ SecurityView.swift           # Security settings
‚îÇ       ‚îî‚îÄ‚îÄ BackupView.swift             # Key backup
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ Group.swift                      # Pool data model
‚îÇ   ‚îú‚îÄ‚îÄ Member.swift                     # Member model
‚îÇ   ‚îú‚îÄ‚îÄ Goal.swift                       # Savings goal
‚îÇ   ‚îú‚îÄ‚îÄ Transaction.swift               # Bitcoin transaction
‚îÇ   ‚îî‚îÄ‚îÄ NostrEvent.swift                # Nostr event model
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ NotificationService.swift        # Push notifications
‚îÇ   ‚îú‚îÄ‚îÄ BackgroundTaskService.swift     # Background updates
‚îÇ   ‚îî‚îÄ‚îÄ QRCodeService.swift             # QR generation/scanning
‚îî‚îÄ‚îÄ Resources/
    ‚îú‚îÄ‚îÄ Localizable.strings              # Localization
    ‚îî‚îÄ‚îÄ Assets.xcassets/                 # Dark mode assets
```

## üîê Two-Tier Encryption Strategy (Based on Seed-E)

### Personal vs Group Data Encryption

Following your Seed-E approach with AES-256-GCM and context-specific keys:

```swift
// Two encryption tiers:
// 1. Personal Data: Only user can decrypt (messages, private keys)
// 2. Group Data: All group members can decrypt (xpubs, balances, goals)

class SatsatEncryptionManager {
    // Personal master key (user-specific, stored in Keychain)
    func getUserMasterKey() -> SymmetricKey

    // Group master key (shared among group members via Nostr)
    func getGroupMasterKey(for groupId: String) -> SymmetricKey

    // Context-specific key derivation (Seed-E approach)
    func deriveContextKey(masterKey: SymmetricKey, context: ContextType, identifier: String) -> SymmetricKey
}
```

### Context-Specific Encryption (Seed-E Pattern)

```swift
// Different contexts for different data types
enum ContextType: String {
    case userPrivateData = "user_private"
    case groupSharedData = "group_shared"
    case userMessages = "user_messages"
    case groupXpub = "group_xpub"        // All members can decrypt
    case groupBalances = "group_balances" // All members can decrypt
    case groupGoals = "group_goals"       // All members can decrypt
}

// Example: Store extended public keys (group-shared)
func storeGroupXpubs(_ xpubData: [MemberXpubData], groupId: String) throws {
    let encryptedData = try encryptionManager.encryptGroupSharedData(
        xpubData,
        groupId: groupId,
        context: .groupXpub
    )
    // Store in Core Data as JSON
}
```

### Database Schema (Encrypted Fields)

```swift
// Core Data entities store encrypted JSON blobs
@objc(EncryptedGroupData)
public class EncryptedGroupData: NSManagedObject {
    @NSManaged public var groupId: String
    @NSManaged public var dataType: String // "xpubs", "balances", "goals"
    @NSManaged public var encryptedData: Data // JSON serialized EncryptedData
    @NSManaged public var lastModified: Date
    @NSManaged public var version: Int32 // For future key rotation
}

// User's private data (messages, keys)
@objc(EncryptedUserData)
public class EncryptedUserData: NSManagedObject {
    @NSManaged public var userId: String
    @NSManaged public var dataType: String
    @NSManaged public var identifier: String
    @NSManaged public var encryptedData: Data
    @NSManaged public var lastModified: Date
}
```

## üì± iOS-Specific Library Recommendations

### Bitcoin Stack

```swift
// Package.swift dependencies
dependencies: [
    // Bitcoin Core
    .package(url: "https://github.com/21-DOT-DEV/swift-secp256k1.git", .upToNextMajor(from: "0.21.1")),
    .package(url: "https://github.com/BlockchainCommons/BCSwiftSecureComponents.git", .upToNextMajor(from: "2.0.0")),

    // Nostr
    .package(url: "https://github.com/nostur-com/nostr-essentials.git", .upToNextMajor(from: "1.0.0")),

    // Lightning (if needed)
    .package(url: "https://github.com/lightningdevkit/ldk-swift", .upToNextMajor(from: "0.1.0")),

    // QR Codes
    .package(url: "https://github.com/dmrschmidt/QRCode", .upToNextMajor(from: "1.0.0")),
]
```

### Multisig Wallet Implementation

```swift
// MultisigWallet.swift
import BCSecureComponents
import P256K

class MultisigWallet: ObservableObject {
    @Published var balance: UInt64 = 0
    @Published var goal: UInt64
    @Published var members: [Member]

    private let threshold: Int
    private let scriptType: ScriptType = .witnessScriptHash

    func generateMultisigAddress() throws -> String {
        let publicKeys = members.compactMap { $0.publicKey }
        guard publicKeys.count >= threshold else {
            throw WalletError.insufficientKeys
        }

        // Create multisig script using BCSecureComponents
        let script = try MultisigScript(
            threshold: threshold,
            publicKeys: publicKeys
        )

        return try script.address(for: .mainnet)
    }

    func createPSBT(to address: String, amount: UInt64) throws -> String {
        // Use Caravan-style PSBT creation
        // Implementation details...
    }
}
```

## üîî Push Notifications Without Backend

### Nostr-Based Notification Strategy

```swift
// NotificationService.swift
import UserNotifications
import NostrEssentials

class NotificationService: ObservableObject {
    private let nostrClient = NostrClient.shared

    func setupNotifications() {
        // Subscribe to group events on Nostr relays
        subscribeToGroupEvents()

        // Handle incoming events
        nostrClient.onEvent = { [weak self] event in
            self?.handleNostrEvent(event)
        }
    }

    private func handleNostrEvent(_ event: NostrEvent) {
        switch event.kind {
        case 1000: // Custom: PSBT requires signing
            scheduleSigningNotification(event)
        case 1001: // Custom: Goal reached
            scheduleGoalNotification(event)
        default:
            break
        }
    }

    private func scheduleSigningNotification(_ event: NostrEvent) {
        let content = UNMutableNotificationContent()
        content.title = "üîê Signature Required"
        content.body = "Your group needs your signature to complete a transaction"
        content.sound = .default
        content.userInfo = ["eventId": event.id]

        let request = UNNotificationRequest(
            identifier: UUID().uuidString,
            content: content,
            trigger: nil
        )

        UNUserNotificationCenter.current().add(request)
    }
}
```

## üè™ App Store Compliance Strategy

### Key Compliance Points

1. **Avoid "Buy" Language**: Use "Request Payment", "Generate Invoice"
2. **No Direct Exchange Features**: Link to external exchanges via Safari
3. **Clear Educational Purpose**: Position as savings/education tool
4. **Proper Disclaimers**: Include financial risk warnings

### App Store Description Template

```
Satsat - Bitcoin Savings Groups

Build financial discipline with friends through collaborative Bitcoin savings goals.

KEY FEATURES:
‚Ä¢ Create savings groups with trusted friends (2-9 people)
‚Ä¢ Set collective Bitcoin savings targets
‚Ä¢ Secure multisig wallet technology
‚Ä¢ Encrypted group messaging
‚Ä¢ Goal tracking and progress sharing

EDUCATIONAL FOCUS:
Learn about Bitcoin, multisig security, and collaborative saving while building healthy financial habits with your social circle.

IMPORTANT: This app is for educational purposes. Bitcoin involves financial risk. Only save amounts you can afford to lose.
```

## ‚ö° Lightning Integration for iOS

### LDK Swift Integration

```swift
// LightningManager.swift
import LightningDevKit

class LightningManager: ObservableObject {
    private var channelManager: ChannelManager?
    private var peerManager: PeerManager?

    func setupLightningNode() {
        // Initialize LDK components for iOS
        // This enables Lightning deposits to the multisig
    }

    func generateInvoice(amountSats: UInt64, memo: String) -> String {
        // Create Lightning invoice for group deposits
        // Implementation using LDK...
    }
}
```

## üöÄ Development Timeline (Revised)

### Day 1-2: Foundation & Security

- Set up project structure
- Implement Keychain integration
- Basic Nostr key generation
- Biometric authentication

### Day 3-4: Core Functionality

- Multisig wallet creation (Caravan integration)
- Group creation/joining via Nostr
- Basic messaging (NIP-04)

### Day 5-6: UI & UX

- Dark mode implementation
- Cash App-inspired design
- QR code scanning/generation
- PSBT signing flow

### Day 7: Polish & Submission

- App Store compliance review
- Final testing
- Submission preparation

This enhanced plan addresses the encryption, iOS-specific libraries, App Store compliance, and detailed architecture that were missing from the original response.
